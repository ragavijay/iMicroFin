@model iMicroFin.Models.MemberLoan

@{
    ViewBag.Title = "View Loan";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="/css/loan/view-loan.css" />

<div class="loan-view-container">
    <div class="loan-card" id="printableArea">
        <div class="card-header">
            <h2>Loan Details</h2>
            <div class="header-actions no-print">
                <a href="@Url.Action("LoanForm", "Loan", new { id = Model.loan.LoanCode })" class="btn-icon">
                    ✏️ Edit Loan
                </a>
                <a href="@Url.Action("ViewMember", "Member", new { id = Model.member.MemberCode })" class="btn-icon">
                    👤 View Member
                </a>
            </div>
        </div>

        <div class="card-body">
            <!-- Header Section with Photo -->
            <div class="loan-header-section">
                <div>
                    <div class="section-title">Basic Information</div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Center Name</span>
                            <span class="info-value">@Model.member.CenterName</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Group Name</span>
                            <span class="info-value">@Model.member.GroupName</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Leader Name</span>
                            <span class="info-value">@Model.member.LeaderName</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Loan ID</span>
                            <span class="info-value">@Model.loan.LoanCode</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Member Code</span>
                            <span class="info-value">@Model.member.MemberCode</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Loan Cycle</span>
                            <span class="info-value">@Model.loan.LoanCycle</span>
                        </div>
                    </div>
                </div>

                <div class="member-photo-container">
                    <img id="memberPhoto" class="member-photo" style="display:none;" alt="Member Photo" />
                    <div id="photoPlaceholder" class="photo-placeholder">
                        No Photo Available
                    </div>
                </div>
            </div>

            <!-- Member Personal Details -->
            <div class="section-title">Member Personal Details</div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Member Name</span>
                    <span class="info-value">@Model.member.MemberName</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Member Type</span>
                    <span class="info-value">@Model.member.MemberType</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Father's Name</span>
                    <span class="info-value">@Model.member.FName</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Husband's Name</span>
                    <span class="info-value">@Model.member.HName</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Date of Birth</span>
                    <span class="info-value">@Model.member.DOB.ToString("dd-MMM-yyyy")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Age</span>
                    <span class="info-value">@Model.member.GetMemberAge() years</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Gender</span>
                    <span class="info-value">@Model.member.Gender</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Marital Status</span>
                    <span class="info-value">@Model.member.MaritalStatus</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Religion</span>
                    <span class="info-value">@Model.member.Religion</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Occupation</span>
                    <span class="info-value">@Model.member.Occupation</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Occupation Type</span>
                    <span class="info-value">@Model.member.OccupationType</span>
                </div>
            </div>

            <!-- Nominee Details -->
            <div class="section-title">Nominee Details</div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Nominee Name</span>
                    <span class="info-value">@Model.member.NomineeName</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Relationship</span>
                    <span class="info-value">@Model.member.Relationship</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Nominee DOB</span>
                    <span class="info-value">@Model.member.NomineeDOB.ToString("dd-MMM-yyyy")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Nominee Age</span>
                    <span class="info-value">@Model.member.GetNomineeAge() years</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Nominee Aadhar</span>
                    <span class="info-value">@Model.member.NomineeAadharNumber</span>
                </div>
            </div>

            <!-- Identity Documents -->
            <div class="section-title">Identity Documents</div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Member Aadhar</span>
                    <span class="info-value">@Model.member.MemberAadharNumber</span>
                </div>
                <div class="info-item">
                    <span class="info-label">PAN Number</span>
                    <span class="info-value">@Model.member.PAN</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Voter ID</span>
                    <span class="info-value">@Model.member.VoterIDNo</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Ration Card No.</span>
                    <span class="info-value">@Model.member.RationCardNo</span>
                </div>
            </div>

            <!-- Bank Details -->
            <div class="section-title">Bank Details</div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Account Number</span>
                    <span class="info-value">@Model.member.AccountNumber</span>
                </div>
                <div class="info-item">
                    <span class="info-label">IFSC Code</span>
                    <span class="info-value">@Model.member.IFSC</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Bank Name</span>
                    <span class="info-value" id="bankName">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Branch</span>
                    <span class="info-value" id="bankBranch">Loading...</span>
                </div>
                <div class="info-item" style="grid-column: 1 / -1;">
                    <span class="info-label">Bank Address</span>
                    <span class="info-value" id="bankAddress">Loading...</span>
                </div>
            </div>

            <!-- Address Details -->
            <div class="section-title">Address Details</div>
            <div class="info-grid">
                <div class="info-item" style="grid-column: 1 / -1;">
                    <span class="info-label">Address</span>
                    <span class="info-value">
                        @Model.member.AddressLine1<br />
                        @if (!string.IsNullOrEmpty(Model.member.AddressLine2))
                        {
                            @Model.member.AddressLine2
                            <br />
 }
                        @if (!string.IsNullOrEmpty(Model.member.AddressLine3))
                        {
                            @Model.member.AddressLine3
                            <br />
 }
                        @if (!string.IsNullOrEmpty(Model.member.AddressLine4))
                        {
                            @Model.member.AddressLine4
                            <br />
 }
                        @Model.member.City, PIN - @Model.member.Pincode
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Taluk</span>
                    <span class="info-value">@Model.member.Taluk</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Panchayat</span>
                    <span class="info-value">@Model.member.Panchayat</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Mobile Number</span>
                    <span class="info-value">@Model.member.Phone</span>
                </div>
            </div>

            <!-- Property Details -->
            <div class="section-title">Property Details</div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Years in Household</span>
                    <span class="info-value">@Model.member.NoOfYears years</span>
                </div>
                <div class="info-item">
                    <span class="info-label">House Type</span>
                    <span class="info-value">@Model.member.HouseType</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Property Ownership</span>
                    <span class="info-value">@Model.member.PropertyOwnership</span>
                </div>
            </div>

            <!-- Loan Details -->
            <div class="section-title">Loan Details</div>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Loan Amount</span>
                    <span class="info-value">₹ @Model.loan.LoanAmount.ToString("N2")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Purpose</span>
                    <span class="info-value">@Model.loan.LoanPurpose</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Processing Fee Rate</span>
                    <span class="info-value">@Model.loan.ProcessingFeeRate%</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Processing Fee</span>
                    <span class="info-value">₹ @Model.loan.ProcessingFee.ToString("N2")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Insurance Rate</span>
                    <span class="info-value">@Model.loan.InsuranceRate%</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Insurance</span>
                    <span class="info-value">₹ @Model.loan.Insurance.ToString("N2")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Tenure</span>
                    <span class="info-value">@Model.loan.Tenure weeks</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Interest Rate</span>
                    <span class="info-value">@Model.loan.InterestRate%</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Weekly Due (EWI)</span>
                    <span class="info-value">₹ @Model.loan.Ewi.ToString("N2")</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Repayment Amount</span>
                    <span class="info-value">₹ @Model.loan.RepaymentAmount.ToString("N2")</span>
                </div>
            </div>

            <!-- Amortization Schedule -->
            <div class="section-title">Amortization Schedule</div>
            <table class="schedule-table" id="scheduleTable">
                <thead>
                    <tr>
                        <th>Week</th>
                        <th>Opening Balance</th>
                        <th>Principal</th>
                        <th>Interest</th>
                        <th>Total</th>
                        <th>Closing Balance</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <!-- Declaration -->
            <div class="section-title" style="margin-top: 2rem;">Declaration</div>
            <div class="declaration-box">
                <p>
                    I, <strong>@Model.member.MemberName</strong> D/o <strong>@Model.member.FName</strong>
                    living at <strong>
                        @Model.member.AddressLine1 @Model.member.AddressLine2 @Model.member.AddressLine3
                        @Model.member.AddressLine4 @Model.member.City - @Model.member.Pincode
                    </strong>
                    received loan for family purpose ₹ <strong>@Model.loan.LoanAmount</strong> from
                    ATHIRSHTAM MICRO FINANCE PRIVATE LTD and I promise I will pay principal with interest.
                </p>
            </div>

            <!-- Signatures -->
            <div class="signature-section">
                <div class="signature-box">
                    <div class="signature-line">Nominee Sign</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line">Center Leader Sign</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line">Member Sign</div>
                </div>
            </div>

            <!-- Company Info -->
            <div class="company-info">
                <p><strong>CIN:</strong> U67200TN2018PTC126199</p>
                <p><strong>ATHIRSHTAM MICRO FINANCE PRIVATE LTD</strong></p>
                <p>PLOT NO 162, DOOR NO 103/2, RAJ PALACE,</p>
                <p>KOCHI DANUSHKODI ROAD, NAGAMALAI PUDUKOTTAI,</p>
                <p>MADURAI - 625019</p>
            </div>

            <!-- Print Button -->
            <div class="print-section">
                <button class="btn-print" onclick="printLoan()">
                    🖨️ Print Loan Details
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load member photo
        loadMemberPhoto();

        // Load bank details
        getBankDetails();

        // Show amortization schedule
        showSchedule();
    });

    // Load member photo from API
    function loadMemberPhoto() {
        const memberCode = '@Model.member.MemberCode';
        const photoElement = document.getElementById('memberPhoto');
        const placeholder = document.getElementById('photoPlaceholder');

        fetch(`/Member/GetMemberPhoto/${memberCode}`)
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error('Photo not found');
            })
            .then(blob => {
                const imageUrl = URL.createObjectURL(blob);
                photoElement.src = imageUrl;
                photoElement.style.display = 'block';
                placeholder.style.display = 'none';
            })
            .catch(error => {
                console.log('No photo available:', error);
                photoElement.style.display = 'none';
                placeholder.style.display = 'flex';
            });
    }

    // Get bank details from IFSC using modern fetch API
    function getBankDetails() {
        const ifsc = '@Model.member.IFSC';
        const bankNameEl = document.getElementById('bankName');
        const bankBranchEl = document.getElementById('bankBranch');
        const bankAddressEl = document.getElementById('bankAddress');

        if (!ifsc || ifsc === '') {
            bankNameEl.textContent = 'Not Available';
            bankBranchEl.textContent = 'Not Available';
            bankAddressEl.textContent = 'Not Available';
            return;
        }

        // Show loading state
        bankNameEl.innerHTML = '<span class="loading-bank">Loading...</span>';
        bankBranchEl.innerHTML = '<span class="loading-bank">Loading...</span>';
        bankAddressEl.innerHTML = '<span class="loading-bank">Loading...</span>';

        fetch(`https://ifsc.razorpay.com/${ifsc}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Bank details not found');
                }
                return response.json();
            })
            .then(bankInfo => {
                bankNameEl.textContent = bankInfo.BANK || 'Not Available';
                bankBranchEl.textContent = bankInfo.BRANCH || 'Not Available';
                bankAddressEl.textContent = bankInfo.ADDRESS || 'Not Available';
            })
            .catch(error => {
                console.error('Error fetching bank details:', error);
                bankNameEl.textContent = 'Unable to fetch';
                bankBranchEl.textContent = 'Unable to fetch';
                bankAddressEl.textContent = 'Unable to fetch';
            });
    }

    // Generate amortization schedule
    function showSchedule() {
        const tenure = @Model.loan.Tenure;
        const interestRate = @Model.loan.InterestRate;
        let balance = @Model.loan.LoanAmount;
        const factor = Math.pow(1 + interestRate / 5200, tenure);
        const ewi = Math.round(balance * interestRate * factor / (factor - 1) / 5200);

        const scheduleTable = document.getElementById("scheduleTable");
        const tbody = scheduleTable.querySelector('tbody');

        for (let i = 1; i <= tenure; i++) {
            const interest = balance * interestRate / 100 / 52;
            const principal = ewi - interest;

            // Calculate closing balance
            if (i === tenure) {
                balance = 0;
            } else {
                balance = balance - ewi + interest;
            }

            // Create row
            const row = tbody.insertRow();
            row.insertCell().textContent = i;
            row.insertCell().textContent = (balance + ewi - interest).toFixed(2);
            row.insertCell().textContent = principal.toFixed(2);
            row.insertCell().textContent = interest.toFixed(2);
            row.insertCell().textContent = ewi.toFixed(2);
            row.insertCell().textContent = Math.abs(balance).toFixed(2);
        }
    }

    // Print loan details
    function printLoan() {
        window.print();
    }
</script>